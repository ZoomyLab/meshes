name: Build Meshes and Upload to Release

on:
  push:
    paths:
      - "**/*.geo"
      - "blacklist.txt"

  workflow_dispatch:
    inputs:
      full_rebuild:
        description: "Rebuild ALL meshes (ignore git diff)?"
        required: false
        default: "false"

jobs:
  build-meshes:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Fetch all tags
      run: git fetch --tags --force

    - name: Install gmsh
      run: sudo apt-get update && sudo apt-get install -y gmsh

    - name: Determine .geo files to process
      id: changed
      run: |
        echo "Manual full rebuild: '${{ github.event.inputs.full_rebuild }}'"

        if [[ "${{ github.event.inputs.full_rebuild }}" == "true" ]]; then
          CHANGED=$(git ls-files '**/*.geo')
        else
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- '**/*.geo')
          else
            CHANGED=$(git ls-files '**/*.geo')
          fi
        fi

        echo "CHANGED FILES:"
        echo "$CHANGED"

        BLACKLIST=$(cat blacklist.txt | tr '\n' ' ')
        echo "BLACKLIST: $BLACKLIST"

        FILTERED=""
        for f in $CHANGED; do
          SKIP=0
          for b in $BLACKLIST; do
            if [[ "$f" == "$b" || "$f" == "$b/"* ]]; then
              SKIP=1
              break
            fi
          done
          [[ $SKIP == 0 ]] && FILTERED="$FILTERED $f"
        done

        echo "FILES TO RUN:"
        echo "$FILTERED"

        echo "files=$FILTERED" >> $GITHUB_OUTPUT

    - name: Run mesh generation
      if: steps.changed.outputs.files != ''
      run: |
        for f in ${{ steps.changed.outputs.files }}; do
          DIR=$(dirname "$f")
          echo "Generating mesh in: $DIR"

          if [[ -f "$DIR/run.sh" ]]; then
            (cd "$DIR" && chmod +x run.sh && ./run.sh)
          else
            echo "::warning ::No run.sh found in '$DIR', skipping."
          fi
        done

    # ---- H5 GENERATION ----
    - name: Generate h5 from msh
      if: steps.changed.outputs.files != ''
      run: |
        echo "Generating H5 files from MSH using zoomy_jax_standalone..."

        docker pull ghcr.io/zoomylab/zoomy_jax_standalone:latest

        # Create script to run in docker
        cat << EOF > gen_h5.py
import glob
from pathlib import Path

from zoomy_core.mesh.mesh import msh_to_h5

files = glob.glob("**/*.msh", recursive=True)

for f in files:
    out = Path(f).with_suffix(".h5")
    print(f"Converting {f} -> {out}")
    msh_to_h5(f)
EOF

        docker run --rm \
          -v $PWD:/work \
          -w /work \
          ghcr.io/zoomylab/zoomy_jax_standalone:latest \
          python gen_h5.py

    # ---- SEMANTIC VERSIONING ----
    - name: Determine next version
      id: version
      run: |
        LATEST=$(git tag --list "meshes-v*" --sort=-v:refname | head -n 1)
        echo "Latest tag: $LATEST"

        if [[ -z "$LATEST" ]]; then
          NEXT="meshes-v0.1.0"
        else
          BASE=${LATEST#meshes-v}
          IFS='.' read -r MAJ MIN PATCH <<< "$BASE"
          PATCH=$((PATCH+1))
          NEXT="meshes-v$MAJ.$MIN.$PATCH"
        fi

        echo "Next tag: $NEXT"
        echo "tag=$NEXT" >> $GITHUB_OUTPUT

    - name: Create Release
      if: steps.changed.outputs.files != ''
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "Meshes Release ${{ steps.version.outputs.tag }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload meshes + geos + h5 with safe naming
      if: steps.changed.outputs.files != ''
      run: |
        TAG=${{ steps.version.outputs.tag }}
        echo "Preparing assets for release $TAG"

        mkdir -p release_assets
        shopt -s globstar
        ANY=0

        # Handle geo, msh, h5
        for EXT in geo msh h5; do
          for f in **/*.$EXT; do
            [[ -f "$f" ]] || continue
            [[ "$f" == .github/* ]] && continue
            ANY=1

            SAFE_NAME=$(echo "$f" | tr '/' '__')
            OUT="release_assets/$SAFE_NAME"

            cp "$f" "$OUT"
            echo "Prepared: $f â†’ $SAFE_NAME"
          done
        done

        if [[ $ANY -eq 0 ]]; then
          echo "Nothing to upload."
        else
          gh release upload "$TAG" release_assets/* --clobber
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
