name: Publish Meshes to GitHub Pages

on:
  workflow_run:
    workflows: ["Build Meshes and Upload to Release"]
    types:
      - completed

  workflow_dispatch:

jobs:
  publish-pages:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest release metadata
        id: release
        run: |
          API="https://api.github.com/repos/${{ github.repository }}/releases/latest"
          echo "Fetching: $API"
          JSON=$(curl -s $API)
          echo "$JSON" > latest.json
          
          TAG=$(echo "$JSON" | jq -r .tag_name)
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Prepare docs folder
        run: |
          rm -rf docs
          mkdir -p docs/meshes

      - name: Download assets from latest release
        run: |
          for asset_url in $(jq -r '.assets[].browser_download_url' latest.json); do
            fname=$(basename "$asset_url")
            echo "Downloading $fname"
            curl -L "$asset_url" -o "docs/meshes/$fname"
          done


          echo "[" > docs/index.json
          FIRST=1
          for f in docs/meshes/*; do
              NAME=$(basename "$f")
              if [[ $FIRST -eq 0 ]]; then echo "," >> docs/index.json; fi
              echo "  \"$NAME\"" >> docs/index.json
              FIRST=0
          done
          echo "]" >> docs/index.json

      - name: Add basic index.html
        run: |
          cat > docs/index.html <<EOF
          <html><body>
          <h1>Meshes</h1>
          <ul>
          $(for f in docs/meshes/*; do echo "<li><a href=\"meshes/$(basename $f)\">$(basename $f)</a></li>"; done)
          </ul>
          </body></html>
          EOF

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy GitHub Pages
        uses: actions/deploy-pages@v4
